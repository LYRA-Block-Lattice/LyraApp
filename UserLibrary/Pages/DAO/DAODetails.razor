@page "/dao/detail/{daoid}"

@using Fluxor
@using Fluxor.Blazor.Web.Components
@using Lyra.Data.Crypto
@using Lyra.Data.Shared
@using Nebula.Store.WebWalletUseCase
@using Microsoft.Extensions.Configuration
@using Lyra.Data.API.WorkFlow
@using UserLibrary.Data
@inherits BasicPage

@if (loading)
{
    <div style="z-index: 5;" class="spinner"></div>
}
else
{
    <div class="mag cet fb">

        <h1>@dao.Name</h1>
        <div>
            @dao.Description
        </div>
        <div>
            Owner: @dao.OwnerAccountId.Shorten()
        </div>
        <div>
            Profit Share Ratio: @(dao.ShareRito * 100) %
        </div>
        <div>
            Seats: @dao.Treasure.Count / @dao.Seats
        </div>
        <div>
            Seller collateral Ratio: @dao.SellerPar %
        </div>
        <div>
            Buyer collateral Ratio: @dao.BuyerPar %
        </div>

        @if (walletState.Value.wallet == null)
        {
            <a href="/wallet"><MudButton Variant="Variant.Filled" Color="Color.Primary">Open Wallet</MudButton></a>
            <br />
        }
        else
        {
            <div>
                <br />
                @if (dao.Treasure.ContainsKey(walletState.Value.wallet.AccountId))
                {
                    <RadzenButton Text="Join or Leave" ButtonStyle="ButtonStyle.Primary"
                         Click="@(a => Navigation.NavigateTo($"/dao/invest/{(dao as TransactionBlock).AccountID}"))"
                   />
                }
                else
                {
                    <RadzenButton Text="Join or Leave" ButtonStyle="ButtonStyle.Primary"
                        Click="@(a => Navigation.NavigateTo($"/dao/invest/{(dao as TransactionBlock).AccountID}"))"
                    />
                }

            </div>
            <br />
            @if (dao.OwnerAccountId == walletState.Value.wallet.AccountId)
            {
                <a href="/dao/createvote/@((dao as TransactionBlock).AccountID)">
                    <RadzenButton Text="Create Vote" ButtonStyle="ButtonStyle.Primary" />
                </a>
                <RadzenButton Text="Edit DAO" ButtonStyle="ButtonStyle.Secondary" />
            }
        }
        <br />
        <div>
            @foreach(var vt in votings)
            {
                <div>
                    <a href="/dao/vote/@((vt as TransactionBlock).AccountID)">@vt.Subject.Title</a>
                </div>
            }
        </div>


    </div>
}




@code {
    [Parameter]
    public string daoid { get; set; }

    public override string DaoId => daoid;
    public override string Title => "DAO Details";

    List<IVoting> votings = new List<IVoting>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            // get all votes
            var allvotret = await lyraApi.FindAllVotesByDaoAsync(DaoId, false);
            if (allvotret.Successful())
            {
                votings = allvotret.GetBlocks().Cast<IVoting>().ToList();
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    async Task ShowCreateVote(string name)
    {
        //check if user has been registed on dealer server
        var client = new DealerClient(Configuration["network"]);
        var user = await client.GetUserByAccountIdAsync(walletState.Value.wallet.AccountId);
        if (!user.Successful())
        {
            // register user
            Navigation.NavigateTo("/dealer/register");
        }
    }
}
