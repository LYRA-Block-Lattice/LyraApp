@page "/nft"
@using Fluxor
@using Lyra.Data.Crypto
@using Microsoft.Extensions.Configuration
@using Nebula.Store.WebWalletUseCase
@using Newtonsoft.Json.Linq
@using OpenSeaClient

	@if (walletState.Value.wallet == null)
	{
		<div class="mag">
		<a href="/wallet"><MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary">Open Wallet</MudButton></a>
		</div>
	}
	else
	{
		<MudTabs Elevation="4" Rounded="true" Centered="true" Color="Color.Secondary">
			<MudTabPanel Text=@localizer["My NFT"]>
				<div class="mag">
					<h3>list my nft here</h3>
				</div>
			</MudTabPanel>

			<MudTabPanel Text=@localizer["Mint"]>
				<div class="mag">
					<table class="table">
						<thead>
							<tr>
								<th>@localizer["Date"]</th>
							<th>@localizer["CID"]</th>
							<th>@localizer["Size"]</th>
							<th>@localizer["Preview"]</th>
							<th></th>
							</tr>
						</thead>
						<tbody>
							@foreach(var file in nsfiles ?? Enumerable.Empty<NFTStorageNFTObject>())
							{
							var url = $"https://{file.cid}.ipfs.nftstorage.link/";
								<tr>
									<td>@file.created</td>
									<td>@file.cid</td>
								<td>@file.size</td>
								<td>
									<img width="128" height="128" src="@url" />
								</td>
								<td>
									<MudButton Variant="MudBlazor.Variant.Filled" Color="Color.Primary">
										@localizer["Mint as NFT"]
									</MudButton>
								</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</MudTabPanel>
		</MudTabs>
	}


@code {
	[Inject] IState<WebWalletState> walletState { get; set; }
	[Inject] ILocalStorageService localStorage { get; set; }
	[Inject] IStringLocalizer<Settings> localizer { get; set; }

	[Inject] IConfiguration Configuration { get; set; }
	[Inject] IDispatcher Dispatcher { get; set; }
	[Inject] ISnackbar Snackbar { get; set; }
	[Inject] ILyraAPI lyraApi { get; set; }

	List<Asset> assetsList = new List<Asset>();
	string keyName = "nftstorageapikey";
	string? apiKey;

	NFTStorageNFTObject[]? nsfiles;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await LoadIpfs();
			StateHasChanged();
		}

		await base.OnAfterRenderAsync(firstRender);
	}

	async Task Mint(string name, string desc, string ipfscid)
	{
		var lsb = await lyraApi.GetLastServiceBlockAsync();
		var acac = new AcademyClient(Configuration["network"]);
		var wallet = walletState.Value.wallet;
		var input = $"{wallet.AccountId}:{lsb.GetBlock().Hash}:{ipfscid}";
		var signatures = Signatures.GetSignature(wallet.PrivateKey, input, wallet.AccountId);
		var ret = await acac.CreateMetaAsync(wallet.AccountId, signatures,
			name, desc, ipfscid);
		dynamic qs = JObject.Parse(ret);
		if(qs.ok)
		{
			var url = qs.value as string;

			// then we can submit a NFT genesis block.
		}
		else
		{
			Snackbar.Add($"Unable to upload metadata: {qs.error}", Severity.Error);
		}
	}

	async Task LoadIpfs()
	{
		// first check api key exists
		apiKey = await localStorage.GetItemAsync<string>(keyName);

		var client = new NFTStorageClient();
		client.SetApiToken(apiKey);
		var files = await client.ListFiles();
		if (files.ok)
			nsfiles = files.value;
		else
			nsfiles = null;
	}

	async Task Load()
	{
        var client = new OpenSeaHttpClient(apiKey: "");

		var queryParams = new GetAssetsQueryParams
		{
			CollectionSlug = "bear-friends",
		};
		var count = 0;
		var limit = 50;
		var it = 0;		

		do
		{
			queryParams.Offset = limit * it;
			queryParams.Limit = limit;

			var assets = await client.GetAssetsAsync(queryParams);

			if (assets != null)
			{
				if (assets.Count > 0)
				{
					assetsList.AddRange(assets);
				}
			}
			else
			{
				break;
			}

			await Task.Delay(1000);
		}
		while (count == 50);

		//assetsList.Dump();


    }
}
