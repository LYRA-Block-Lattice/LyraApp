@namespace UserLibrary.Components

@using Blazored.LocalStorage
@using Fluxor
@using Lyra.Core.API
@using Nebula.Store.WebWalletUseCase
@using UserLibrary.Data
@implements IDisposable

@if (hasStore && !walletState.Value.IsBackuped)
{
    <div style="width:100%;">
        <MudLink Href="/backup" Underline="Underline.None">
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled">Wallet not backup. Tap here to backup your wallet.</MudAlert>
        </MudLink>
    </div>
}

@code
{
    [Inject]
    private IState<WebWalletState>? walletState { get; set; }
    [Inject]
    private IDispatcher Dispatcher { get; set; }
    [Inject] 
    private ILocalStorageService localStorage { get; set; }
    [Inject] NebulaConsts _consts { get; set; }

    bool hasStore;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            walletState.StateChanged += this.WalletChanged;

            if (await localStorage.ContainKeyAsync(_consts.NebulaStorName))
                hasStore = true;
            else
                hasStore = false;

            if(hasStore)
            {
                var s = await localStorage.GetItemAsync<string>(_consts.NebulaStorName);
                Dispatcher.Dispatch(new WebWalletBackupAction
                    {
                        IsBackuped = s == "Yes"
                    });       
            }     
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private void WalletChanged(object sender, WebWalletState wallet)
    {
        InvokeAsync(() => StateHasChanged());
    }

    public void Dispose()
    {
        walletState.StateChanged -= this.WalletChanged;
    }    
}